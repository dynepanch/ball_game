<!DOCTYPE html>
<!SPDX-FileCopyrightText: 2023 Ken Inaba rightman20020920@yahoo.co,jp>
<!#-Licence-Identifire: BSD-3-Clause>

<html lang="en-US">
	<head>
		<meta charset="utf-8" />
		<title>ball game </title>
			<center>	
				左右移動：左右キー
				<br>
				ボール投下：下キー
			</center>
		<style>
			* {
				padding : 0;
				margin : 0;
			 }
			canvas {
				background : #ece;
				display : block;
				margin : 0 auto;
			}
		</style>
	</head>
	<body>
		
		<canvas id="game_canvas" width = "480" height="600" ></canvas>
		
		<script>
			
			const max_ball_num=10000;
			const canvas=document.getElementById("game_canvas");
			const ctx = canvas.getContext("2d");
			let relativeX;
			let cli=0;
			let cli_2=0;
			let ball_x=new Array(max_ball_num);
			let ball_y=new Array(max_ball_num);
			let ball_r=new Array(max_ball_num);
			let ball_fall_start=new Array(max_ball_num);
			let now_ball_num=1;
			let start=new Array(max_ball_num);
			let ay=new Array(max_ball_num);
			let ax=new Array(max_ball_num);
			let vx=new Array(max_ball_num);
			let vy=new Array(max_ball_num);
			let m=new Array(max_ball_num);
			let b_rank=new Array(max_ball_num);
			let g=new Array(max_ball_num);
			var score=0;
			var s=new Array(max_ball_num);
			var gameover=0;
			var rightPressed= false;
			var leftPressed= false;
			var downPressed= false;
			
			document.addEventListener("keydown",keyDownHandler,false);
			document.addEventListener("keyup",keyUpHandler,false);
			
			document.addEventListener("mousemove", mouseMoveHandler, false);
			
			canvas.addEventListener('click',function(){
				cli=1;
				cli_2=1;
			});
			
			function mouseMoveHandler(e){
				relativeX=e.clientX - canvas.offsetLeft;
			}
			
			function keyDownHandler(e){
				if(e.key=="Right" || e.key == "ArrowRight"){
					rightPressed=true;
				}else if(e.key=="Left" || e.key == "ArrowLeft"){
					leftPressed=true;
				}else if(e.key=="Down"|| e.key == "ArrowDown"){
					downPressed=true;
				}
			}

			function keyUpHandler(e){
				if(e.key=="Right" || e.key == "ArrowRight"){
					rightPressed=false;
				}else if(e.key=="Left" || e.key == "ArrowLeft"){
					leftPressed=false;
				}else if(e.key=="Down"|| e.key == "ArrowDown"){
					downPressed=false;
				}

			}
						
			let i=0;
			
			for(i=0;i<max_ball_num;i++){
					ball_x[i]=100+(canvas.width-200)/2;
					ball_y[i]=10;
					ay[i]=0;
					ax[i]=0;
					vy[i]=0;
					vx[i]=0;
					g[i]=0.01;
					s[i]=0;
					b_rank[i]=Math.floor(Math.random()*3+1);
					start[i]=0;
					ball_fall_start[i]=0;
				}
			function frame(){
				ctx.beginPath();
				ctx.rect(100, 40,canvas.width-200, canvas.height-100);
				ctx.strokeStyle = "black";
				ctx.stroke();
				ctx.closePath();
			}
			
			
			
			function check(){
				let k;
				let j;
				let buffvx;
				let buffvy;
				
				for(k=0;k<now_ball_num;k++){
					for(j=0;j<now_ball_num;j++){
						if(k!=j && b_rank[j]>0 && b_rank[k]>0 && ball_fall_start[j]==1 && ball_fall_start[k]==1){
						distance=(ball_x[k]-ball_x[j])*(ball_x[k]-ball_x[j])+(ball_y[k]-ball_y[j])*(ball_y[k]-ball_y[j]);
							if(distance<(ball_r[k]+ball_r[j])*(ball_r[k]+ball_r[j])){
								if(ball_x[k]+ball_r[k]>ball_x[j]-ball_r[j]){
									g[k]=0.01;
									g[j]=0.01;
										if(b_rank[k]==b_rank[j]){
											b_rank[k]=0;
											b_rank[j]+=1;
											vy[j]=-0.01;
											score+=b_rank[j]*2;
											for(i=k;i<now_ball_num-1;i++){
												ball_x[i]=ball_x[i+1];
												ball_y[i]=ball_y[i+1];
												ball_r[i]=ball_r[i+1];
												ay[i]=ay[i+1];
												ax[i]=ax[i+1];
												vx[i]=vx[i+1];
												vy[i]=vy[i+1];
												m[i]=m[i+1];
												s[i]=0;
												b_rank[i]=b_rank[i+1];
												ball_fall_start[i]=ball_fall_start[i+1];
												
											}
											ball_x[i]=100+(canvas.width-200)/2;
											ball_y[i]=10;
											ay[i]=0;
											ax[i]=0;
											vy[i]=0;
											vx[i]=0;
											if(b_rank[i]<=0 || b_rank[i]>3){
												b_rank[i]=Math.floor(Math.random()*3+1);
											}
											start[i]=0;
											ball_fall_start[i]=0;
											now_ball_num-=1;
											break;
										}else{	
											buffvx=vx[k];
											vx[k]=(m[k]*vx[k]+m[j]*vx[j]-m[j]*vx[j]*0.9)/m[k];
											vx[j]=(m[k]*buffvx+m[j]*vx[j]-m[k]*vx[k])/m[j];
											}		
								}
								if(ball_y[k]+ball_r[k]>ball_y[j]-ball_r[j]){
										buffvy=vy[k];
										vy[k]=(m[k]*vy[k]+m[j]*vy[j]-m[j]*vy[j]*0.9)/m[k];
										vy[j]=(m[k]*buffvy+m[j]*vy[j]-m[k]*vy[k])/m[j];
								}
								if(ball_x[k]<ball_x[j]){
									vx[k]=-0.2;
									vx[j]=0.2;
								}else{
									vx[k]=0.2;
									vx[j]=-0.2;
								}
								if(ball_y[k]<ball_y[j]){
									vy[k]=-0.1;
									vy[j]=0.01;
								}else{
									vy[k]=0.01;
									vy[j]=-0.1;
								}
							}else{
								g[k]=0.01;
								g[j]=0.01;
							}
								
							
						}
					}
				}
			}	
			
			function draw_ball(id,r,ball_color,mas){
				
				ball_r[id]=r;
				m[id]=mas;
				ball_y[id]+=vy[id];
				ball_x[id]+=vx[id];
				
				
				
				if(ball_fall_start[id]==1){
					if(ball_y[id]>10 && s[id]>4){
						gameover=1;
					}
					if((ball_x[id]-ball_r[id]>100 || ball_x[id]+ball_r[id]<canvas.width-200+100)){	
						vx[id]+=ax[id];
					}
					if(ball_y[id]<(canvas.height-100)+40-ball_r[id]){	
					vy[id]+=ay[id]+g[id];
					ax[id]=0;
					}else{
						if(vx[id]>0){
								ax[id]=-1*g[id]*0.05;
							}else if(vx[id]<0){
								ax[id]=g[id]*0.05;
							}
					}
						
					if(ball_x[id]-ball_r[id]<100 || ball_x[id]+ball_r[id]>canvas.width-200+100){
							vx[id]*=-0.1;
						}	
					if(ball_y[id]>(canvas.height-100)+40-ball_r[id]){
						vy[id]*=-0.1;
					}
				}else{
					
					if(rightPressed || (relativeX>ball_x[id]&&relativeX<canvas.width)){
						ball_x[id]++;
					}
					if(leftPressed || (relativeX<ball_x[id] &&relativeX>0)){
						ball_x[id]--;
					}
					if(downPressed || cli==1){
							ball_fall_start[id]=1;
							cli=0;
					}
				}
				while(ball_y[id]-2>(canvas.height-100)+40-ball_r[id]){
					ball_y[id]-=1;
				}
				while(ball_x[id]-ball_r[id]<100){
					vx[id]=0.01;
					//vy[id]=1;
					ball_r[id]=r;
				m[id]=mas;
				ball_y[id]+=vy[id];
				ball_x[id]+=vx[id];
				}
				while(ball_x[id]+ball_r[id]>canvas.width-200+100){
					vx[id]=-0.1;
					//vy[id]=1;
					ball_r[id]=r;
				m[id]=mas;
				ball_y[id]+=vy[id];
				ball_x[id]+=vx[id];
				}
				
				/*if(start==1 && ball_y[now_ball_num]>50){
					now_ball_num++;
					start=0;
				}*/
				check();
				ctx.beginPath();
				ctx.arc(ball_x[id], ball_y[id], ball_r[id], 0, Math.PI * 2, false);
				ctx.fillStyle = ball_color;
				ctx.fill();
				ctx.closePath();
				
			}
			
			function rank_ball(id,rank){
				switch(rank){
					case 1:
								draw_ball(id,10,"red",30);
					break;
					
					case 2:
								draw_ball(id,15,"blue",28);
					break;
					
					case 3:
								draw_ball(id,20,"green",25);
					break;
					
					case 4:
								draw_ball(id,25,"yellow",23);
					break;
					
					case 5:
								draw_ball(id,30,"black",28);
					break;
					
					case 6:
								draw_ball(id,40,"white",28);
					break;
					
					case 7:
								draw_ball(id,50,"#e0bf",28);
					break;
					
					case 8:
								draw_ball(id,60,"#aebf",28);
					break;
					
					case 9:
								draw_ball(id,70,"#bfaf",28);
					break;
					
					case 10:
								draw_ball(id,80,"#aecf",28);
					break;
					
					case 11:
								draw_ball(id,90,"#bf7a",28);
					break;
					
					case 12:
								draw_ball(id,110,"#b77a",28);
					break;
					
				
				}
			}
			
			function next_ball(){
			let r;
				switch(b_rank[now_ball_num]){
					case 1:
								ball_color="red";
								r=10;
					break;
					
					case 2:
								ball_color="blue";
								r=15;
					break;
					
					case 3:
								r=20;
								ball_color="green";
					break;
					
					case 4:
								r=25;
								ball_color="yellow";
					break;
					
					case 5:
								r=30;
								ball_color="black";
					break;
					
					case 6:
								r=40;
								ball_color="white";
					break;
					
					case 7:
								r=50;
								ball_color="#e0bf";
					break;
					
					case 8:
								r=60;
								ball_color="#aebf";
					break;
					
					case 9:
								r=70;
								ball_color="#bfaf";
					break;
					
					case 10:
								r=80;
								ball_color="#aecf";
					break;
					
					case 11:
								r=90;
								ball_color="#bf7a";
					break;
					
					case 12:
								r=100;
								ball_color="#b77a";
					break;
				}
				ctx.beginPath();
				ctx.fillText("next",400,50);
				ctx.font="16px Arial";
				ctx.arc(430, 70, r, 0, Math.PI * 2, false);
				ctx.fillStyle = ball_color;
				ctx.fill();
				ctx.closePath();
			}
			
			function draw(){
				let r;
				ctx.clearRect(0,0,canvas.width,canvas.height);
				for(r=0;r<now_ball_num;r++){
					if(b_rank[r]>0){
						rank_ball(r,b_rank[r]);
						
					}
				}
				if(now_ball_num<max_ball_num){
					if(ball_fall_start[now_ball_num-1]>=1 && ball_y[now_ball_num-1]>50){
						now_ball_num++;
						if(cli_2==1){
							cli=0;
						}
					}
										
				}
				
				frame();
				ctx.font="16px Arial";
				
				ctx.fillText(`Score: ${score}`,8,20);
				if(gameover==1){
					//now_ball_num=0;
					alert("GAME OVER");
				}
				next_ball();
			}
			
			
			setInterval(draw,10);
			
			function over(){
			let r;
				for(r=0;r<now_ball_num;r++){	
					if(ball_y[r]<50 && ball_fall_start[r]==1){
								s[r]++;
								console.log(s[r]);
					}else{
						s[r]=0;
					}
				}
			}
			setInterval(over,1000);
		</script>
	
	</body>
</html>
